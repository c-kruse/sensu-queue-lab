# NSQ

[NSQ][nsq] is a non-durable distributed messaging platform. I am evaluating it
to see if it may be a compliment to [sensu-go][sensu-go] in its use case for a
queue.

## Local test setup

A small test environment is available locally in a docker-compose stack. It
contains three nsqd services, a single nsqlookupd instance and nsqadmin.

The base image for these services is built locally and includes the built perf
testing scripts under the `cmd` directory.

The `./runLocalTest.sh` script starts the compose-stack and executes some modest
load against the nsq cluster.

## Perf Suite

The `infra` directory includes a terraform root module that stands up a more
realistic nsq cluster in AWS. The cluster consists of three nodes for nsqd, a
single nsqlookupd and three additional nodes to act as consumers. It also
includes a single host for running prometheus collecting node and statsd
metrics from the cluster. The nsqd and consumer nodes run `c5.2xlarge`
instances (8 vCPUs, 16 GB memory) and the rest run `c5.xlarge`.

A `site.yaml` ansible playbook is set up to configure the cluster. In addition
to the inventory files generated by terraform, this playbook has a dependency
on the built test tools. Run `make build` to build these binaries (requires go).

`make build && ansible-playbook -i infra/ansible/inventory infra/ansible/site.yaml`

### Test Playbooks

Three playbooks, `_prime_tests.yaml`, `_test_reads.yaml` and
`_test_writes.yaml` are set up to add load to the cluster. The prime tests
playbook restarts the nsqd services (needed as nsqd recoveres memory rather
slowly), and creates the topics and channels by adding minimal load for a few
seconds in order to prime the nsqlookupd service. The test writes playbook
starts publishers on the nsqd instances, aiming to publish a constant load of
40k messages per second across the entire cluster spread across a configurable
number of topics. The test reads playbook is set up to simulate 50k sensu
agents subscribed to a configurable number of topics. Each of these test
playbooks run for 5 minutes.

[nsq]: https://nsq.io
[sensu-go]: https://github.com/sensu/sensu-go
